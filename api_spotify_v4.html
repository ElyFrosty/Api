<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>api_spotify_v4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <h2>Spotify Api V4</h2>

    <div id="buttBack" style="display: none;"> 
        <button onclick="indietro()" type="button" class="btn btn-primary">Indietro</button>
        <h3>Dettagli dell'album:</h3>
    </div>
    
    <div id="spotifyPlayer"></div>

    <div id="visAlbum" style="display: none;">
        <table class="table table-hover">
            <thead>
                <tr> 
                    <th>Ascolta</th>
                    <th>Titolo</th>
                    <th>Durata</th>
                  </tr>
            </thead>
            <tbody id="tbody1">
    
            </tbody>
        </table>
    </div>

    <div id="tablePrinc">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Artista</th>
                    <th>Titolo</th>
                    <th>Copertina</th>
                    <th>Ascolta brano</th>
                    <th>Ascolta album</th>
                  </tr>
            </thead>
            <tbody id="tbody">
    
            </tbody>
        </table>
    </div>
    

    <script>
        var access_token="BQDHoFG_GcpCFFg2QUGu-ehhirsq1f4BF_fhFEaoW0OZmvPIGd5m8Gf9gtQh5_DDrP8NrAa6yTwuyqaUaqQD9nlPWAgJdiA10z7KSjYPC0rxM3VZn-vdetQATv-4VBphVGbSM1WLz0DRsAnqLI9fKGBPFyzNj7S3I3UHZ3yjd_K6YS6Du_j8n4Bb6ke05VYqHXvsXyNY68DM4TWlqLL0";
        async function fetchAlbumData(str){
            try{
                const response= await fetch (`https://api.spotify.com/v1/`+str,{
                    headers:{
                        'Authorization': 'Bearer ' + access_token
                    }
                });
                if (!response.ok){
                    throw new Error('Errore nella richiesta: '+response.status);
                }
                const userData= await response.json();
                console.log(userData)
                return userData;
            }catch(error){
                console.error("Errore durante la richiesta: ", error);
                return null;
            }
        }

        async function renderTable(){
            try{
                const jsonTrackData=await fetchAlbumData("me/player/recently-played");
                let tbody = "";
                jsonTrackData['items'].forEach(track => {
                    tbody += `<tr><td><a href="${track['track']['artists'][0]['external_urls']['spotify']}">${track['track']['artists'][0]['name']}</a></td>`;
                    tbody += `<td>${track['track']['name']}</td>`;
                    tbody += `<td><img src="${track['track']['album']['images'][0]['url']}" alt="Copertina" style="width: 100px;"></td>`;
                    tbody += `<td><button onclick="playSong('${track['track']['id']}','${track['track']['name']}')" class="btn btn-dark">Ascolta</button></td>`;
                    tbody += `<td><button onclick="playAlbum('${track['track']['album']['images'][1]['url']}','${track['track']['album']['name']}','${track['track']['album']['id']}')" class="btn btn-info">Ascolta</button></td>`;
                    tbody += "</tr>";
                });
            //console.log(tbody);
            document.getElementById("tbody").innerHTML=tbody;
            }catch(error){
                console.error("Errore durante il rendering della tabella: ",error);  
            }
        }
        renderTable()

        async function playSong(songId,songTitle){
            const playerDiv=document.getElementById('spotifyPlayer');
            const playerHtml= `
                <div>
                    <p>Stai ascoltando: ${songTitle}</p>
                    <iframe src="https://open.spotify.com/embed/track/${songId}"
                        width="300" height="80" frameborder="0" allowtransparency="true" allow="encripted-media">
                    </iframe>
                </div>
            `;
            playerDiv.innerHTML=playerHtml;
        }

        async function playAlbum(albumImg, albumName, albumId){
            document.getElementById('buttBack').style.display ='block';
            document.getElementById('visAlbum').style.display ='block';
            document.getElementById('tablePrinc').style.display ='none';
                   
            const albumDiv=document.getElementById('visAlbum');
            try{
                const jsonTrackData=await fetchAlbumData('albums/'+albumId);
                console.log(jsonTrackData['tracks']);
                let tbody = "";
                const brani=jsonTrackData['tracks']['items'];
                
                for (brano of brani){
                    console.log(brano);
                    tbody += `<tr><td><button onclick="playSong('${brano['id']}','${brano['name']}')" class="btn btn-dark">Ascolta</button></td>`;
                    tbody += `<td>${brano['name']}</td>`;
                    tbody += `<td>${msToTime(brano['duration_ms'])}</td>`;
                    tbody += "</tr>";
                }
            
                // jsonTrackData['tracks'].forEach(track => {
                //     tbody += `<tr><td><button onclick="playSong('${track['track']['id']}','${track['track']['name']}')" class="btn btn-dark">Ascolta</button></td>`;
                //     tbody += `<td>${track['track']['name']}</td>`;
                //     tbody += `<td>${msToTime(track['track']['duration_ms'])}</td>`;
                //     tbody += "</tr>";
                // });
            
            document.getElementById("tbody1").innerHTML=tbody;
            }catch(error){
                console.error("Errore durante il rendering della tabella: ",error);  
            }
        }

        async function indietro(){
            document.getElementById('buttBack').style.display ='none';
            document.getElementById('visAlbum').style.display ='none';
            document.getElementById('tablePrinc').style.display ='block';
        }

        function msToTime(msDurata){
            var millisecondi = (msDurata%1000)/100;
            var secondi = Math.round((msDurata/1000)%60);
            var minuti = Math.round((msDurata/(1000*60))%60);
            var ore = (msDurata/(1000*60*60))%24;
            ore = (ore<10) ? "0" + ore : ore;
            minuti = (minuti<10) ? "0" + minuti : minuti;
            secondi = (secondi<10) ? "0" + secondi : secondi;
            return minuti + ":" + secondi
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>